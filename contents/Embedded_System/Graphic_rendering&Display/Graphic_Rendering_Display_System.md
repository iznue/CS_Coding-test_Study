# Wayland 
- Wayland는 X11을 대체하는 디스플레이 서버 프로토콜로, 간단하며 보안성 높은 그래픽 구성을 목표로 함
- 리눅스 데스크탑 환경을 구현하기 위한 프로토콜로, 컴포지터와 클라이언트의 통신을 지원함
- X11과 달리 컴포지터를 직접 구현하지 않으며, 대신 프로토콜과 관련 API를 제공하고 컴포지터와 쉘은 서드파티가 구현하도록 함
&rarr; 따라서 유연하며 확장성있는 구조를 취하며 Wayfire와 같이 창의적인 데스크탑 환경을 만들 수 있게 되었음

- 데스크탑 환경은 크게 **컴포지터**와 **쉘**로 구분됨
    - UI가 쉘을 그리고, 애플리케이션들의 창이 겹쳐졌을 때 처리를 컴포지터가 함
- Wayland는 컴포지터와 쉘의 구현을 돕는 API와 쉘이 애플리케이션과 통신할 수 있도록 프로토콜을 제공함

- Wayland 이전에는 X11이 컴포지터(X Server)의 역할을 했으며, 이 위에서 Gnome, KDE와 같은 서드파티 쉘이 동작했음
- 하지만 커널 구조가 많이 변경되면서 이전에는 X11에서 처리했던 많은 일들이 DRI, DRM 등을 통해 커널이 처리하기 시작했음
&rarr; 즉 X11이라는 단일 컴포지터가 모든 쉘을 관리하는 모델은 리눅스 GUI 환경 변화를 따라오기에는 너무 거대했기에 Wayland가 탄생함

> wayland를 사용하는 대표적인 이유
> 1. 기존 X11대비 경량화, 체계화된 framework
>     - 기존 X11이 사용하지 않는 부분을 제거하고 필요한 부분만을 구현함
>     - 표준 GEM/DRM 스택을 이용해 최대한 단순하게 구현함 (커널에서 DRM/GEM을 지원해 더 이상 user framework가 복잡해질 필요가 없음)
>     - X11의 1/10의 크기
> 2. Genivi, AGL, Tizen 플랫폼에서 사용함

### Wayland & X Window
- wayland는 기존 X window를 더 단순하게 바꾸려는 목적으로 wayland 레퍼런스 컴포지터인 weston의 개발이 함께 시작됨
- X window에서 수행되던 많은 하부 기능들이 커널이나 라이브러리로 옮겨져 사용되지 않음에도 불구하고 user는 잔존해 있는 X protocol을 지원해야만 했기에 해당 wayland 오픈소스 프로젝트가 시작됨

|X window|wayland|
|---|---|
|독립적인 프로세스로서 동작|라이브러리 형태로 구현되어 OS의 오버헤드가 줄어듦|
|서버와 컴포지터가 분리되어 있음|서버와 컴포지터가 하나로 합쳐져 불필요한 통신이 줄어듦|
|렌더링을 서버가 담당|렌더링을 크라이언트가 담당하여 서버와의 복잡도가 감소함|
|X 서버가 클라이언트, 컴포지터, 커널간의 모든 동작을 중개함|서버가 클라이언트와 커널만 중개함|

### Wayland 동작 과정
![wayland](./img/wayland.png)
1. 커널은 이벤트(예: input event)를 가져와 컴포지터로 전달함
2. 컴포지터는 어떤 윈도우가 이벤트를 수신해야하는지 결정함
3. 클라이언트는 이벤트를 수신하면 클라이언트에서 렌더링이 발생함. 클라이언트가 컴포지터에게 업데이트된 영역을 표시하는 요청만 보냄
4. 컴포지터는 클라이언트로부터 요청을 받은 다음 화면을 다시 구성하고, 직접 ioctl을 실행해 KMS로 최종화면을 요청함

- 애플리케이션은 EGL을 사용해 직접 컨텐츠를 그리고, compositor와(새 컨텐츠를 렌더링했는지) 통신함
- EGL은 DRM API를 사용해 버퍼에 엑세스 할 수 있으며, 프레임 버퍼는 DRM에 의해 관리됨

[Wayland](./Wayland.md)

---
# Weston
- wayland는 라이브러리로써 X11을 대체하기 위해 Weston과 같은 컴포지터를 필요로 함
- wayland는 결국 protocol / compositor를 구현하며 윈도우들을 여러 계층으로(레이어) 구분해 관리함
- shell plugin(desktop-shell, xdg-shell...)을 지원하며 shell을 이용해 출력되는 각 윈도우(뷰)의 순서를 결정함
- 윈도우를 화면에 나타나게 하거나 위치를 옮기거나 크기를 변경하는 기능을 지원함

![weston](./img/weston.png)

- weston compositor는 weston의 동작을 준비 / 실행하는 핵심 component임
    - 1. wayland 객체, backend 컴포넌트, shell 컴포넌트를 생성 / 로딩 / 실행
      2. 주요 wayland interface의 동작 (=컴포지팅) 정의
- weston 컴포지터 코드는 compositor 폴더에서 찾을 수 있으며, **libweston** 폴더를 참조함

